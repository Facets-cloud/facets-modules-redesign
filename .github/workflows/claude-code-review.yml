name: Claude Facets Module Validation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'modules/**'
      - 'outputs/**'
      - 'rules.md'
      - 'project-type/**'

jobs:
  claude-validate:
    if: >-
      github.event.pull_request.author_association == 'MEMBER' ||
      github.event.pull_request.author_association == 'OWNER'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Raptor CLI
        run: |
          curl -L -o raptor https://github.com/Facets-cloud/raptor/releases/latest/download/raptor-linux-amd64
          chmod +x raptor
          sudo mv raptor /usr/local/bin/raptor

      - name: Run Claude Facets Validation
        env:
          CONTROL_PLANE_URL: ${{ secrets.CONTROL_PLANE_URL }}
          FACETS_USERNAME: ${{ secrets.FACETS_USERNAME }}
          FACETS_TOKEN: ${{ secrets.FACETS_TOKEN }}
          FACETS_PROFILE: "1155708878"
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          plugin_marketplaces: |
            https://github.com/Facets-cloud/claude-plugin
          plugins: |
            facets-plugin@facets-marketplace
          claude_args: '--max-turns 30 --allowedTools "Bash(raptor:*),Bash(terraform:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(file:*),Bash(head:*),Bash(tail:*),Bash(curl:*),Bash(wget:*),Bash(find:*),Bash(grep:*),Bash(awk:*),Bash(sed:*),Bash(wc:*),Bash(sort:*),Bash(uniq:*),Bash(diff:*),Bash(echo:*),Bash(pwd:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(chmod:*),Bash(which:*),Bash(env:*),Bash(jq:*),Bash(yq:*),Read,Write,Edit,Grep,Glob,WebSearch"'
          prompt: |
            You are reviewing and validating Facets modules changed in this PR.

            ## Step 1 — Detect changed modules

            Run `gh pr diff --name-only` to list all changed files in this PR.
            For each changed file, walk up the file path to find the nearest directory containing a `facets.yaml` file. That directory is the module path.
            Deduplicate the list to get unique module directories.
            Print the list of modules that will be validated before proceeding.
            If no modules are found, comment "No module changes detected" and stop.

            ## Step 2 — Review and validate each module

            First, invoke the /module-development skill to load Facets module development standards. Use this knowledge throughout your review for understanding module structure, conventions, spec schemas, output types, and Terraform patterns.

            Then, use the /facets-modules-validate skill to validate each detected module. Follow its full 6-step process exactly:
            1. Module detection (already done in Step 1 — pass the list)
            2. Read rules.md and all module files
            3. Systematic rule-by-rule validation (PASS/FAIL/SKIP for every rule)
            4. Raptor dry-run with FACETS_PROFILE=1155708878
            5. Per-module report tables
            6. New rule discovery

            In addition to rules.md validation, perform a thorough review of the Terraform code itself. Check that resource configurations are valid and will work as intended, variable types and defaults are correct, references between resources are sound, conditionals and loops are logically correct, there are no hardcoded values that should be configurable, and there are no security concerns (overly permissive IAM, open security groups, unencrypted resources). Compare with sibling modules of the same intent to spot deviations from established patterns. Report code review findings in a separate **Code Review** section after the rules table, with severity levels: **Critical** (will break), **Warning** (potential issue), **Suggestion** (improvement).

            ## Important constraints
            - NEVER use `--skip-validation` with raptor
            - If security scan fails, retry with `--skip-security-scan` but report findings in a table
            - Be thorough and critical in both rule validation and code review, not lenient
            - Report ALL rules (PASS, FAIL, or SKIP with reason) — do not skip rules silently
