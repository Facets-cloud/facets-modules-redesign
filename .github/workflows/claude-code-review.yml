name: Claude Facets Module Validation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'modules/**'
      - 'outputs/**'
      - 'rules.md'
      - 'project-type/**'

jobs:
  claude-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Raptor CLI
        run: |
          curl -L -o raptor https://github.com/Facets-cloud/raptor/releases/latest/download/raptor-linux-amd64
          chmod +x raptor
          sudo mv raptor /usr/local/bin/raptor

      - name: Run Claude Facets Validation
        env:
          CONTROL_PLANE_URL: ${{ secrets.CONTROL_PLANE_URL }}
          FACETS_USERNAME: ${{ secrets.FACETS_USERNAME }}
          FACETS_TOKEN: ${{ secrets.FACETS_TOKEN }}
          FACETS_PROFILE: "1155708878"
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          plugin_marketplaces: |
            https://github.com/Facets-cloud/claude-plugin
          plugins: |
            facets-plugin@facets-marketplace
          claude_args: '--max-turns 30 --allowedTools "Bash(raptor:*),Bash(terraform:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(file:*),Bash(head:*),Bash(tail:*),Bash(curl:*),Bash(wget:*),Bash(find:*),Bash(grep:*),Bash(awk:*),Bash(sed:*),Bash(wc:*),Bash(sort:*),Bash(uniq:*),Bash(diff:*),Bash(echo:*),Bash(pwd:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(chmod:*),Bash(which:*),Bash(env:*),Bash(jq:*),Bash(yq:*),Read,Write,Edit,Grep,Glob,WebSearch"'
          prompt: |
            You are validating Facets modules changed in this PR.

            ## Step 1 — Detect changed modules

            Run `gh pr diff --name-only` to list all changed files in this PR.
            For each changed file, walk up the file path to find the nearest directory containing a `facets.yaml` file. That directory is the module path.
            Deduplicate the list to get unique module directories.
            Print the list of modules that will be validated before proceeding.
            If no modules are found, comment "No module changes detected" and stop.

            ## Step 2 — Validate each module

            Use the /facets-modules-validate skill to validate each detected module. Follow its full 6-step process exactly:
            1. Module detection (already done in Step 1 — pass the list)
            2. Read rules.md and all module files
            3. Systematic rule-by-rule validation (PASS/FAIL/SKIP for every rule)
            4. Raptor dry-run with FACETS_PROFILE=1155708878
            5. Per-module report tables
            6. New rule discovery

            The /module-development skill is also available — use it as reference for module structure standards and conventions.

            ## Step 3 — Terraform code review

            Beyond rules.md validation, perform a thorough review of the actual Terraform code in each module. Check for:

            **Correctness:**
            - Are resource configurations valid and will they work as intended?
            - Are variable types, defaults, and descriptions correct?
            - Are references between resources correct (no dangling refs, correct attribute access)?
            - Are provider-specific arguments valid for the resource types used?
            - Are `for_each`, `count`, and dynamic blocks used correctly?

            **Logic & design:**
            - Does the module logic make sense for its stated intent/purpose?
            - Are there redundant or dead code paths?
            - Are conditionals and ternary expressions logically sound?
            - Are locals computed correctly and used appropriately?
            - Does the deep merge / default handling work as expected?

            **Best practices:**
            - Are there hardcoded values that should be configurable via spec?
            - Are there security concerns (overly permissive IAM, open security groups, unencrypted resources)?
            - Are resource dependencies implicit where they should be explicit (or vice versa)?
            - Are outputs complete and useful for downstream consumers?

            **Consistency with existing modules:**
            - Compare with other modules of the same intent/flavor to spot deviations from established patterns
            - Check if naming conventions match sibling modules

            Report findings in a separate **Code Review** section after the rules table, with severity levels: **Critical** (will break), **Warning** (potential issue), **Suggestion** (improvement).

            ## Important constraints
            - NEVER use `--skip-validation` with raptor
            - If security scan fails, retry with `--skip-security-scan` but report findings in a table
            - Be thorough and critical in both rule validation and code review, not lenient
            - Report ALL rules (PASS, FAIL, or SKIP with reason) — do not skip rules silently
