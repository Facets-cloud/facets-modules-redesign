name: Claude Facets Module Validation

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'modules/**'
      - 'datastore/**'
      - 'outputs/**'

jobs:
  claude-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Raptor CLI
        run: |
          curl -L -o raptor https://github.com/Facets-cloud/raptor/releases/latest/download/raptor-linux-amd64
          chmod +x raptor
          sudo mv raptor /usr/local/bin/raptor

      - name: Run Claude Facets Validation
        env:
          CONTROL_PLANE_URL: ${{ secrets.CONTROL_PLANE_URL }}
          FACETS_USERNAME: ${{ secrets.FACETS_USERNAME }}
          FACETS_TOKEN: ${{ secrets.FACETS_TOKEN }}
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are validating a Facets module PR.

            ## Required Reading (ALWAYS read these first)
            1. Read CLAUDE.md for repository structure and raptor commands
            2. Read rules.md for validation ruleset - understand these rules to identify violations
            3. Find relevant `*_module_standard.md` for each changed module type

            ## Your Task
            1. Identify which modules were changed in this PR using `gh pr diff`
            2. For each changed module, run: `raptor create iac-module -f <module-path> --dry-run`
            3. If validation fails, identify which rules from rules.md were violated
            4. Follow behavior guidelines from CLAUDE.md for handling security scan and provider issues

            ## Output Format
            Post a PR comment with:
            - List of modules validated
            - For each issue: rule ID (e.g., RULE-004), description, and fix suggestion
            - Security scan results in table format (if any)
            - Provider issues (if any)

            Use `gh pr comment` to post your validation report.

          claude_args: '--allowed-tools "Bash(raptor:*),Bash(terraform:*),Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(ls:*),Bash(file:*),Bash(head:*),Bash(tail:*),Bash(curl:*),Bash(wget:*),Bash(find:*),Bash(grep:*),Bash(awk:*),Bash(sed:*),Bash(wc:*),Bash(sort:*),Bash(uniq:*),Bash(diff:*),Bash(echo:*),Bash(pwd:*),Bash(mkdir:*),Bash(cp:*),Bash(mv:*),Bash(rm:*),Bash(chmod:*),Bash(which:*),Bash(env:*),Bash(jq:*),Bash(yq:*),Read,Grep,Glob,WebSearch"'
