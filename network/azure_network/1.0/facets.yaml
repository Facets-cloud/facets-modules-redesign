intent: network
flavor: azure-network
version: '1.0'
description: Creates an Azure Virtual Network with automatically calculated subnet sizes, including dedicated database subnets with proper delegation for PostgreSQL and MySQL Flexible Servers
clouds:
- azure
inputs:
  cloud_account:
    type: '@facets/azure_cloud_account'
    displayName: Cloud Account
    description: The Azure Cloud Account where the network resources will be created
    optional: false
    providers:
    - azurerm
spec:
  type: object
  properties:
    vnet_cidr:
      type: string
      title: VNet CIDR Block (/16 only)
      description: CIDR block for the Virtual Network (must be a /16 block, e.g., 10.0.0.0/16)
      pattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/16$
      x-ui-overrides-only: true
      x-ui-error-message: CIDR must be a valid /16 IP block (e.g., 10.0.0.0/16)
      x-ui-placeholder: 10.0.0.0/16
    region:
      type: string
      title: Azure Region
      description: Azure region where the VNet will be created
    availability_zones:
      type: array
      title: Availability Zones
      description: List of availability zones to use for subnets (e.g., ["1", "2", "3"])
      items:
        type: string
      minItems: 1
      maxItems: 3
      x-ui-override-disable: true
    nat_gateway:
      type: object
      title: NAT Gateway Configuration
      properties:
        strategy:
          type: string
          title: NAT Gateway Strategy
          description: Choose whether to create one NAT Gateway or one per availability zone
          enum:
          - single
          - per_az
          default: single
      required:
      - strategy
    database_config:
      type: object
      title: Database Subnet Configuration
      description: Configuration for database-related subnets and DNS zones
      properties:
        enable_database_subnets:
          type: boolean
          title: Enable Database Subnets
          description: Create dedicated subnets for database services (creates 3 /24 subnets)
          default: true
        database_subnet_cidrs:
          type: object
          title: Database Subnet CIDRs
          description: CIDR blocks for database subnets (must be /24 blocks within VNet CIDR)
          properties:
            general:
              type: string
              title: General Database Subnet
              description: For database resources that don't require delegation
              pattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/24$
              x-ui-placeholder: 10.0.100.0/24
            postgresql:
              type: string
              title: PostgreSQL Delegated Subnet
              description: Delegated subnet for all PostgreSQL Flexible Servers
              pattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/24$
              x-ui-placeholder: 10.0.101.0/24
            mysql:
              type: string
              title: MySQL Delegated Subnet
              description: Delegated subnet for all MySQL Flexible Servers
              pattern: ^([0-9]{1,3}\.){3}[0-9]{1,3}/24$
              x-ui-placeholder: 10.0.102.0/24
        create_dns_zones:
          type: object
          title: DNS Zone Creation
          description: Create private DNS zones for database services
          properties:
            postgresql:
              type: boolean
              title: Create PostgreSQL DNS Zone
              description: Create private DNS zone for PostgreSQL Flexible Servers
              default: true
            mysql:
              type: boolean
              title: Create MySQL DNS Zone
              description: Create private DNS zone for MySQL Flexible Servers
              default: true
      required:
      - enable_database_subnets
    tags:
      type: object
      title: Additional Tags
      description: Optional additional tags to apply to all VNet resources
      x-ui-yaml-editor: true
  required:
  - vnet_cidr
  - region
  - availability_zones
  - nat_gateway
outputs:
  default:
    type: '@facets/azure-network-details'
    title: Azure Network Details with Database Networking
sample:
  kind: network
  flavor: azure-network
  version: '1.0'
  spec:
    vnet_cidr: 10.0.0.0/16
    region: centralindia
    availability_zones:
    - '1'
    - '2'
    - '3'
    nat_gateway:
      strategy: single
    database_config:
      enable_database_subnets: true
      database_subnet_cidrs:
        general: 10.0.100.0/24
        postgresql: 10.0.101.0/24
        mysql: 10.0.102.0/24
      create_dns_zones:
        postgresql: true
        mysql: true
iac:
  validated_files:
  - variables.tf
  - locals.tf
  - network.tf
  - subnets.tf
  - database-subnets.tf
  - dns-zones.tf
  - nat-gateway.tf
  - routing.tf
  - security-groups.tf
  - outputs.tf
