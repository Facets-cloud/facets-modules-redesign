intent: postgres
flavor: azure-flexible-server
version: '1.0'
clouds:
- azure
description: A developer-friendly PostgreSQL flexible server with secure defaults
  and restore capabilities
spec:
  title: PostgreSQL Flexible Server on Azure
  description: A developer-friendly PostgreSQL flexible server with secure defaults
    and restore capabilities
  type: object
  properties:
    version_config:
      type: object
      title: Version & Basic Configuration
      x-ui-toggle: false
      properties:
        version:
          type: string
          title: PostgreSQL Version
          description: Version of the PostgreSQL engine
          enum:
          - '13'
          - '14'
          - '15'
          default: '15'
        tier:
          type: string
          title: Performance Tier
          description: Server performance tier
          enum:
          - Burstable
          - GeneralPurpose
          - MemoryOptimized
          default: GeneralPurpose
        database_name:
          type: string
          title: Database Name
          description: Initial database name to create. Use 'postgres' for default
            system database (read-only, cannot be managed)
          default: postgres
          pattern: ^[a-zA-Z][a-zA-Z0-9_]{0,62}$
      required:
      - version
      - tier
    sizing:
      type: object
      title: Sizing & Performance
      x-ui-toggle: false
      properties:
        sku_name:
          type: string
          title: Server Size
          description: SKU name for the PostgreSQL server
          enum:
          - B_Standard_B1ms
          - B_Standard_B2s
          - GP_Standard_D2s_v3
          - GP_Standard_D4s_v3
          - GP_Standard_D8s_v3
          - MO_Standard_E2s_v3
          - MO_Standard_E4s_v3
          default: GP_Standard_D2s_v3
        storage_gb:
          type: number
          title: Storage Size (GB)
          description: Storage capacity in gigabytes
          minimum: 32
          maximum: 16384
          default: 128
        read_replica_count:
          type: number
          title: Read Replica Count
          description: Number of read replicas to create
          minimum: 0
          maximum: 5
          default: 0
      required:
      - sku_name
      - storage_gb
    restore_config:
      type: object
      title: Restore Operations
      x-ui-overrides-only: true
      x-ui-toggle: true
      properties:
        restore_from_backup:
          type: boolean
          title: Restore from Backup
          description: Restore database from existing backup
          default: false
        source_server_id:
          type: string
          title: Source Server ID
          description: Azure resource ID of the source PostgreSQL server for restore
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
        restore_point_in_time:
          type: string
          title: Restore Point in Time
          description: Point in time to restore to (RFC3339 format)
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
        admin_username:
          type: string
          title: Admin Username
          description: Admin username for the restored server (required for restore
            operations)
          pattern: ^[a-zA-Z][a-zA-Z0-9_]*$
          minLength: 1
          maxLength: 63
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
        admin_password:
          type: string
          title: Admin Password
          description: Admin password for the restored server (required for restore
            operations)
          minLength: 8
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
      required: []
    imports:
      type: object
      title: Import Existing Resources
      x-ui-overrides-only: true
      x-ui-toggle: true
      properties:
        flexible_server_id:
          type: string
          title: Flexible Server ID
          description: Full Azure resource ID of existing PostgreSQL Flexible Server
            (format:/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{name})
        postgres_database_id:
          type: string
          title: Custom Database ID (Optional)
          description: Full Azure resource ID of custom database for import - NOT
            for "postgres" system database (format:/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.DBforPostgreSQL/flexibleServers/{server}/databases/{name})
        admin_password:
          type: string
          title: Admin Password
          description: Admin password for the imported server (8+ characters)
          minLength: 8
      required: []
  required:
  - version_config
  - sizing
inputs:
  azure_provider:
    type: '@facets/azure_cloud_account'
    optional: false
    displayName: Azure Cloud Account
    description: Azure credentials and provider configuration
    providers:
    - azurerm
  network_details:
    type: '@facets/azure-network-details'
    optional: false
    displayName: Azure Network Details
    description: Azure VNet with PostgreSQL delegated subnet and DNS zone configuration
outputs:
  default:
    type: '@facets/postgres'
    title: PostgreSQL Azure Flexible Server
imports:
- name: flexible_server_id
  resource_address: azurerm_postgresql_flexible_server.main
  required: false
- name: postgres_database_id
  resource_address: azurerm_postgresql_flexible_server_database.databases[0]
  required: false
- name: admin_password
  resource_address: random_password.admin_password[0]
  required: true
iac:
  validated_files:
  - main.tf
  - variables.tf
  - locals.tf
sample:
  kind: postgres
  flavor: azure-flexible-server
  version: '1.0'
  disabled: true
  spec:
    version_config:
      version: '15'
      tier: GeneralPurpose
      database_name: myappdb
    sizing:
      sku_name: GP_Standard_D2s_v3
      storage_gb: 128
