intent: postgres
flavor: gcp-cloudsql
version: '1.0'
clouds:
- gcp
description: Managed PostgreSQL database using Google Cloud SQL with secure defaults
  and high availability
intentDetails:
  type: Datastores
  description: Google Cloud SQL PostgreSQL managed database
  displayName: PostgreSQL
  iconUrl: https://raw.githubusercontent.com/Facets-cloud/facets-modules-redesign/main/icons/postgres.svg
spec:
  title: PostgreSQL CloudSQL Database
  description: Managed PostgreSQL database using Google Cloud SQL with secure defaults
    and high availability
  type: object
  x-ui-order:
  - version_config
  - sizing
  - network_config
  - restore_config
  - imports
  properties:
    version_config:
      type: object
      title: Version & Basic Configuration
      x-ui-order:
      - version
      - database_name
      properties:
        version:
          type: string
          title: PostgreSQL Version
          description: Version of the PostgreSQL database engine
          enum:
          - '13'
          - '14'
          - '15'
          default: '15'
        database_name:
          type: string
          title: Database Name
          description: Name of the default database to create
          pattern: ^[a-zA-Z][a-zA-Z0-9_]*$
          default: app_db
    sizing:
      type: object
      title: Sizing & Performance
      x-ui-order:
      - tier
      - disk_size
      - read_replica_count
      properties:
        tier:
          type: string
          title: Instance Tier
          description: Cloud SQL instance tier. PostgreSQL supports only shared-core
            or custom machine types.
          enum:
          - db-f1-micro
          - db-g1-small
          - db-custom-2-7680
          - db-custom-4-16384
          - db-custom-8-32768
          - db-custom-16-65536
          default: db-custom-2-7680
        disk_size:
          type: number
          title: Disk Size (GB)
          description: Initial disk size in GB
          minimum: 10
          maximum: 30720
          default: 100
        read_replica_count:
          type: number
          title: Read Replica Count
          description: Number of read replicas to create
          minimum: 0
          maximum: 5
          default: 0
    network_config:
      type: object
      title: Network Configuration
      x-ui-toggle: true
      x-ui-order:
      - ipv4_enabled
      - require_ssl
      - authorized_networks
      properties:
        ipv4_enabled:
          type: boolean
          title: Enable Public IP
          description: Enable public IP address for the instance
          default: false
        require_ssl:
          type: boolean
          title: Require SSL
          description: Require SSL for connections
          default: true
        authorized_networks:
          type: object
          title: Authorized Networks
          description: Map of authorized networks that can connect to the instance
          default: {}
          x-ui-visible-if:
            field: spec.network_config.ipv4_enabled
            values:
            - true
          patternProperties:
            ^[a-zA-Z0-9_-]+$:
              type: object
              properties:
                value:
                  type: string
                  title: CIDR Range
                  description: CIDR notation (e.g., 0.0.0.0/0 for all, or specific
                    IP/range)
              required:
              - value
    restore_config:
      type: object
      title: Restore Operations
      x-ui-overrides-only: true
      x-ui-order:
      - restore_from_backup
      - source_instance_id
      - master_username
      - master_password
      properties:
        restore_from_backup:
          type: boolean
          title: Restore from Backup
          description: Restore database from existing backup
          default: false
        source_instance_id:
          type: string
          title: Source Instance ID
          description: Source Cloud SQL instance ID for restore
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
        master_username:
          type: string
          title: Master Username
          description: Master username for restored database (required when restoring)
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
        master_password:
          type: string
          title: Master Password
          description: Master password for restored database (required when restoring)
          minLength: 8
          pattern: ^[a-zA-Z0-9!@#$%^&*()_+=\-]{8,}$
          x-ui-error-message: Password must be 8+ chars with valid characters.
          x-ui-visible-if:
            field: spec.restore_config.restore_from_backup
            values:
            - true
    imports:
      type: object
      title: Import Existing Resources
      x-ui-overrides-only: true
      x-ui-order:
      - import_existing
      - instance_id
      - database_name
      - user_name
      - master_password
      properties:
        import_existing:
          type: boolean
          title: Import Existing Resources
          description: Enable to import existing CloudSQL resources
          default: false
        instance_id:
          type: string
          title: Cloud SQL Instance ID
          description: ID of existing Cloud SQL instance to import
          x-ui-visible-if:
            field: spec.imports.import_existing
            values:
            - true
        database_name:
          type: string
          title: Database Name
          description: Name of existing database to import
          x-ui-visible-if:
            field: spec.imports.import_existing
            values:
            - true
        user_name:
          type: string
          title: User Name
          description: Name of existing database user to import
          x-ui-visible-if:
            field: spec.imports.import_existing
            values:
            - true
        master_password:
          type: string
          title: Master Password
          description: Master password for the imported resource (8+ characters)
          minLength: 8
          pattern: ^[a-zA-Z0-9!@#$%^&*()_+=\-]{8,}$
          x-ui-error-message: Password must be 8+ chars with valid characters.
          x-ui-visible-if:
            field: spec.imports.import_existing
            values:
            - true
  required:
  - version_config
  - sizing
imports:
- name: instance_id
  resource_address: google_sql_database_instance.postgres_instance
  required: false
- name: database_name
  resource_address: google_sql_database.initial_database
  required: false
- name: user_name
  resource_address: google_sql_user.postgres_user
  required: false
- name: master_password
  resource_address: random_password.postgres_password[0]
  required: true
inputs:
  gcp_provider:
    type: '@facets/gcp_cloud_account'
    optional: false
    displayName: GCP Provider
    description: GCP cloud account configuration and credentials
    providers:
    - google
  network:
    type: '@facets/gcp-network-details'
    optional: false
    displayName: GCP Network
    description: GCP VPC network configuration for database placement
outputs:
  default:
    type: '@facets/postgres'
    title: PostgreSQL CloudSQL
iac:
  validated_files:
  - main.tf
  - variables.tf
  - locals.tf
sample:
  kind: postgres
  flavor: gcp-cloudsql
  version: '1.0'
  disabled: true
  spec:
    version_config:
      version: '15'
      database_name: app_db
    sizing:
      tier: db-custom-2-7680
      disk_size: 100
      read_replica_count: 0
    network_config:
      ipv4_enabled: false
      require_ssl: true
    restore_config:
      restore_from_backup: false
