intent: k8s_access_controls
flavor: k8s_standard
version: "1.0"
description: |
  Creates Kubernetes RBAC Roles and ClusterRoles for access control.
  Includes default read and debug roles for Facets platform integration.
clouds:
  - kubernetes

inputs:
  kubernetes_details:
    type: "@facets/kubernetes-details"
    optional: false
    displayName: Kubernetes Cluster
    description: Kubernetes cluster for deploying RBAC resources
    default:
      resource_type: kubernetes_cluster
      resource_name: default
    providers:
      - kubernetes

outputs:
  default:
    type: "@outputs/k8s_access_controls"
    title: Kubernetes Access Controls

spec:
  title: Kubernetes Access Controls Configuration
  description: Configure RBAC Roles and ClusterRoles
  type: object
  properties:
    roles:
      type: object
      title: Namespace Roles
      description: Custom Kubernetes Roles (namespaced). Default roles (cc-read-role, cc-debug-role) are created automatically.
      patternProperties:
        "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$":
          type: object
          title: Role Definition
          properties:
            metadata:
              type: object
              title: Metadata
              properties:
                namespace:
                  type: string
                  title: Namespace
                  description: Namespace for the role (defaults to environment namespace)
                annotations:
                  type: object
                  title: Annotations
                  x-ui-yaml-editor: true
                labels:
                  type: object
                  title: Labels
                  x-ui-yaml-editor: true
            rules:
              type: object
              title: Rules
              description: RBAC rules for this role
              patternProperties:
                "^[a-zA-Z0-9_-]+$":
                  type: object
                  title: Rule
                  properties:
                    api_groups:
                      x-ui-override-disable: true
                      type: array
                      title: API Groups
                      description: API groups (use empty string for core group)
                      items:
                        type: string
                    resources:
                      x-ui-override-disable: true
                      type: array
                      title: Resources
                      description: Kubernetes resources
                      items:
                        type: string
                    resource_names:
                      x-ui-override-disable: true
                      type: array
                      title: Resource Names
                      description: Specific resource names (optional)
                      items:
                        type: string
                    verbs:
                      x-ui-override-disable: true
                      type: array
                      title: Verbs
                      description: Allowed actions
                      items:
                        type: string
                        enum:
                          - get
                          - list
                          - watch
                          - create
                          - update
                          - patch
                          - delete
                          - deletecollection
                  required:
                    - api_groups
                    - resources
                    - verbs
          required:
            - rules
    cluster_roles:
      type: object
      title: Cluster Roles
      description: Custom ClusterRoles (cluster-wide). Default cluster roles are created automatically in base environments.
      patternProperties:
        "^[a-z0-9]([-a-z0-9]*[a-z0-9])?$":
          type: object
          title: ClusterRole Definition
          properties:
            metadata:
              type: object
              title: Metadata
              properties:
                annotations:
                  type: object
                  title: Annotations
                  x-ui-yaml-editor: true
                labels:
                  type: object
                  title: Labels
                  x-ui-yaml-editor: true
            rules:
              type: object
              title: Rules
              description: RBAC rules for this cluster role
              patternProperties:
                "^[a-zA-Z0-9_-]+$":
                  type: object
                  title: Rule
                  properties:
                    api_groups:
                      x-ui-override-disable: true
                      type: array
                      title: API Groups
                      description: API groups (use empty string for core group)
                      items:
                        type: string
                    resources:
                      x-ui-override-disable: true
                      type: array
                      title: Resources
                      description: Kubernetes resources
                      items:
                        type: string
                    resource_names:
                      x-ui-override-disable: true
                      type: array
                      title: Resource Names
                      description: Specific resource names (optional)
                      items:
                        type: string
                    non_resource_urls:
                      x-ui-override-disable: true
                      type: array
                      title: Non-Resource URLs
                      description: Non-resource URLs (optional)
                      items:
                        type: string
                    verbs:
                      x-ui-override-disable: true
                      type: array
                      title: Verbs
                      description: Allowed actions
                      items:
                        type: string
                        enum:
                          - get
                          - list
                          - watch
                          - create
                          - update
                          - patch
                          - delete
                          - deletecollection
                  required:
                    - verbs
          required:
            - rules
  x-ui-order:
    - roles
    - cluster_roles

sample:
  kind: k8s_access_controls
  flavor: k8s_standard
  version: "1.0"
  disabled: false
  spec: {}
