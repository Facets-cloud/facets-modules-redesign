# WireGuard VPN Server Module (v1.0)

## Overview

This module deploys a WireGuard VPN server instance on Kubernetes using the wireguard-operator's CRD-based approach. It creates a `Wireguard` custom resource that is managed by the wireguard-operator, providing a declarative way to deploy VPN infrastructure.

## Prerequisites

- **WireGuard Operator**: This module requires the wireguard-operator to be deployed first using the `wireguard/standard` module
- **Kubernetes Cluster**: A running Kubernetes cluster with appropriate permissions
- **Node Pool**: A dedicated node pool for VPN workloads

## Environment as Dimension

This module is environment-aware and adapts its configuration based on:

- **Cloud Provider**: Automatically applies cloud-specific service annotations and MTU settings
  - **AWS**: Configures external NLB with IP target type
  - **Azure**: Configures public load balancer
  - **GCP**: set MTU to 1380 for compatibility
- **Namespace**: Uses environment namespace by default, can be overridden
- **Node Scheduling**: Applies environment-specific node selectors and tolerations

## Resources Created

- **Wireguard CRD Instance**: A custom resource managed by wireguard-operator that deploys:
  - WireGuard server deployment with configured settings
  - LoadBalancer service endpoint for external access
  - Secrets for server keys (auto-generated by operator)
  - ConfigMaps for WireGuard configuration

## Key Features

- **Operator-Managed**: Leverages wireguard-operator for lifecycle management
- **Automatic Key Generation**: Server keys are automatically generated and stored as Kubernetes secrets
- **Cloud-Aware Configuration**: Automatically configures service annotations and MTU based on cloud provider
- **Node Pool Integration**: Schedules VPN pods on designated node pools with proper tolerations
- **LoadBalancer Service**: Exposes VPN server via LoadBalancer service type

## Configuration Highlights

### MTU Configuration
- Default: 1500
- GCP: Automatically set to 1380 for compatibility
- Custom values supported via `spec.mtu`

### Service Annotations
Cloud-specific annotations are automatically applied for AWS and Azure load balancers. Additional custom annotations can be provided via `spec.service_annotations`.

### IP Forwarding
Enabled by default to allow proper VPN routing. Can be disabled if not needed.

## Security Considerations

- Server private keys are stored as Kubernetes secrets
- VPN pods run with necessary privileges for network configuration
- Service endpoints are internet-facing by default (configure security groups/firewall rules accordingly)
- Consider implementing network policies to restrict VPN pod access

## Peer Management

After deploying the VPN server, peers can be created using `WireguardPeer` CRDs. Peer configurations are automatically generated and stored in secrets named `<wireguard-name>-peer-configs`.

## Accessing Peer Configurations

Retrieve peer configuration:
```bash
kubectl get secret <instance-name>-peer-configs -n <namespace> -o jsonpath='{.data.<peer-name>}' | base64 -d
```

## Dependencies

- wireguard-operator (deployed via `wireguard/standard` module)
- kubernetes-details (cluster connection)
- kubernetes_nodepool (scheduling configuration)